From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Martin Wilck <mwilck@suse.com>
Date: Fri, 18 Dec 2020 22:18:20 +0100
Subject: [PATCH] github workflow: use zram device as test block device

Signed-off-by: Benjamin Marzinski <bmarzins@redhat.com>
---
 .github/workflows/build-and-unittest.yaml | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/.github/workflows/build-and-unittest.yaml b/.github/workflows/build-and-unittest.yaml
index 2b13c65c..ef55b8c1 100644
--- a/.github/workflows/build-and-unittest.yaml
+++ b/.github/workflows/build-and-unittest.yaml
@@ -5,6 +5,14 @@ jobs:
     runs-on: ubuntu-latest
     steps:
       - uses: actions/checkout@v2
+      - name: mpath
+        run: sudo modprobe dm_multipath
+      - name: zram
+        run: sudo modprobe zram num_devices=0
+      - name: zram-device
+        run: echo ZRAM=$(sudo cat /sys/class/zram-control/hot_add) >> $GITHUB_ENV
+      - name: set-zram-size
+        run: echo 1G | sudo tee /sys/block/zram$ZRAM/disksize
       - name: dependencies
         run: >
           sudo apt-get install --yes gcc
@@ -15,3 +23,7 @@ jobs:
         run: make -O -j$(grep -c ^processor /proc/cpuinfo)
       - name: test
         run: make -O -j$(grep -c ^processor /proc/cpuinfo) test
+      - name: clean-nonroot-artifacts
+        run: rm -f tests/dmevents.out tests/directio.out
+      - name: root-test
+        run: sudo make DIO_TEST_DEV=/dev/zram$ZRAM test
